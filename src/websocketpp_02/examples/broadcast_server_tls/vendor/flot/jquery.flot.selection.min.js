(function(a){function b(k){var p={first:{x:-1,y:-1},second:{x:-1,y:-1},show:false,active:false};var m={};var r=null;function e(s){if(p.active){l(s);k.getplaceholder().trigger("plotselecting",[g()])}}function n(s){if(s.which!=1){return}document.body.focus();if(document.onselectstart!==undefined&&m.onselectstart==null){m.onselectstart=document.onselectstart;document.onselectstart=function(){return false}}if(document.ondrag!==undefined&&m.ondrag==null){m.ondrag=document.ondrag;document.ondrag=function(){return false}}d(p.first,s);p.active=true;r=function(t){j(t)};a(document).one("mouseup",r)}function j(s){r=null;if(document.onselectstart!==undefined){document.onselectstart=m.onselectstart}if(document.ondrag!==undefined){document.ondrag=m.ondrag}p.active=false;l(s);if(f()){i()}else{k.getplaceholder().trigger("plotunselected",[]);k.getplaceholder().trigger("plotselecting",[null])}return false}function g(){if(!f()){return null}var u={},t=p.first,s=p.second;a.each(k.getaxes(),function(v,w){if(w.used){var y=w.c2p(t[w.direction]),x=w.c2p(s[w.direction]);u[v]={from:math.min(y,x),to:math.max(y,x)}}});return u}function i(){var s=g();k.getplaceholder().trigger("plotselected",[s]);if(s.xaxis&&s.yaxis){k.getplaceholder().trigger("selected",[{x1:s.xaxis.from,y1:s.yaxis.from,x2:s.xaxis.to,y2:s.yaxis.to}])}}function h(t,u,s){return u<t?t:(u>s?s:u)}function d(w,t){var v=k.getoptions();var u=k.getplaceholder().offset();var s=k.getplotoffset();w.x=h(0,t.pagex-u.left-s.left,k.width());w.y=h(0,t.pagey-u.top-s.top,k.height());if(v.selection.mode=="y"){w.x=w==p.first?0:k.width()}if(v.selection.mode=="x"){w.y=w==p.first?0:k.height()}}function l(s){if(s.pagex==null){return}d(p.second,s);if(f()){p.show=true;k.triggerredrawoverlay()}else{q(true)}}function q(s){if(p.show){p.show=false;k.triggerredrawoverlay();if(!s){k.getplaceholder().trigger("plotunselected",[])}}}function c(s,w){var t,y,z,a,x=k.getaxes();for(var u in x){t=x[u];if(t.direction==w){a=w+t.n+"axis";if(!s[a]&&t.n==1){a=w+"axis"}if(s[a]){y=s[a].from;z=s[a].to;break}}}if(!s[a]){t=w=="x"?k.getxaxes()[0]:k.getyaxes()[0];y=s[w+"1"];z=s[w+"2"]}if(y!=null&&z!=null&&y>z){var v=y;y=z;z=v}return{from:y,to:z,axis:t}}function o(t,s){var v,u,w=k.getoptions();if(w.selection.mode=="y"){p.first.x=0;p.second.x=k.width()}else{u=c(t,"x");p.first.x=u.axis.p2c(u.from);p.second.x=u.axis.p2c(u.to)}if(w.selection.mode=="x"){p.first.y=0;p.second.y=k.height()}else{u=c(t,"y");p.first.y=u.axis.p2c(u.from);p.second.y=u.axis.p2c(u.to)}p.show=true;k.triggerredrawoverlay();if(!s&&f()){i()}}function f(){var s=5;return math.abs(p.second.x-p.first.x)>=s&&math.abs(p.second.y-p.first.y)>=s}k.clearselection=q;k.setselection=o;k.getselection=g;k.hooks.bindevents.push(function(t,s){var u=t.getoptions();if(u.selection.mode!=null){s.mousemove(e);s.mousedown(n)}});k.hooks.drawoverlay.push(function(v,d){if(p.show&&f()){var t=v.getplotoffset();var s=v.getoptions();d.save();d.translate(t.left,t.top);var z=a.color.parse(s.selection.color);d.strokestyle=z.scale("a",0.8).tostring();d.linewidth=1;d.linejoin="round";d.fillstyle=z.scale("a",0.4).tostring();var b=math.min(p.first.x,p.second.x),a=math.min(p.first.y,p.second.y),c=math.abs(p.second.x-p.first.x),u=math.abs(p.second.y-p.first.y);d.fillrect(b,a,c,u);d.strokerect(b,a,c,u);d.restore()}});k.hooks.shutdown.push(function(t,s){s.unbind("mousemove",e);s.unbind("mousedown",n);if(r){a(document).unbind("mouseup",r)}})}a.plot.plugins.push({init:b,options:{selection:{mode:null,color:"#e8cfac"}},name:"selection",version:"1.1"})})(jquery);